<html lang="en">

<head>
    <%- include('partials/header') %>
</head>

<body>
    <%- include('partials/serverMessage') %>
    <main>

        <form id="addForm">

            <!-- <h1>Create poem</h1> -->
            <h4>1. Choose the title of your poem</h4>
            <div class="poemContent">
                <input id="createTitle" type="text" placeholder="title" name="name" required/>
            <h4 class="marginTop30">2. Paste one of your favourite lyrics in the poem field or click to choose one of the suggested lyrics below</h4>
            <button value="river" onclick="getLyric(value)">River, by Joni Mitchel</button>
            <button value="blank space" onclick="getLyric(value)">Blank space, by Taylor Swift</button>
            <button value="hallelujah" onclick="getLyric(value)">Hallelujah, by Leonard Cohen</button>
            <button value="love will tear us apart" onclick="getLyric(value)">Love will tear us apart, by Joy division</button>

                <input id="createpoem" type="text" placeholder="poem" name="poem" required/>
            </div>
        
            <button id="addForm" type="submit">Let's start creating!</button>
        </form>

        <div id="editContainer" hidden>
            <div class="visibilityButtons">
                <input type="radio" name="visibility" id="public" value="public">
                <label for="public">Public</label>
                <input type="radio" name="visibility" id="private" value="private">
                <label for="private">Private</label>
            </div>
                <div id="editedPoem"></div>
                
                <button onclick="tryagain()" >Delete and try again</button>
                <button type="submit" onclick="newPoemValue()"><a href="/poems">Create poem</a></button>

                <div id="textAreaDiv" class="marginTop30">
                    <textarea readonly id="editPoem"></textarea>
                </div>
            </div>

    
    </main>
</body>

<script>
    const createPoemForm = document.getElementById('addForm');
    const textAreaDiv = document.getElementById('textAreaDiv');
    const editContainer = document.getElementById('editContainer')
    const inputTitle = document.getElementById('createTitle');
    const inputPoem = document.getElementById('createpoem');
    const editPoem = document.getElementById('editPoem');
    const editedPoem = document.getElementById('editedPoem');
    const radioButtons = document.querySelectorAll('input[name="visibility"]')
  
    function getLyric(str) {
        fetch('lyrics.json')
    .then(res => res.json())
    .then(data => {
        let chosenSong = data.filter(song => song.title === str)
        chosenSong.map(info => {
            inputPoem.value = info.lyrics
        })
    })
    }
    createPoemForm.addEventListener('submit', (e) => {
        e.preventDefault();
        createPoemForm.style.display = 'none';
        editContainer.hidden = false; 

        const h2Tag = document.createElement('h2');
        h2Tag.innerText = inputTitle.value.trim();
        h2Tag.style.display = "inline";
        h2Tag.setAttribute('id', 'h2Title')

        editContainer.prepend(h2Tag)
        editPoem.innerText = inputPoem.value;
    })
         

    editPoem.addEventListener("mouseup", onMouseUp, false)

    function onMouseUp() {
        const activeTextarea = document.activeElement;
        const selection = activeTextarea.value.substring(
            activeTextarea.selectionStart, activeTextarea.selectionEnd)
        console.log(selection)
        const pTag = document.createElement('p');
        pTag.innerText = `${selection.trim()}`
        editedPoem.appendChild(pTag)
    }

    function tryagain() {
        editedPoem.innerHTML = "";
    }

    function newPoemValue() {
        console.log(editedPoem.textContent)
        const h2Title = document.getElementById('h2Title')

        let visibilityValue;
            for (const radioButton of radioButtons) {
                if (radioButton.checked) {
                    visibilityValue = radioButton.value;
                    break;
                }
            }
        
            console.log(visibilityValue, editedPoem.innerText)

        fetch('/createpoem', {
            method: "POST",
            headers: {
              "Content-Type": "application/json", // let server know that body is a string of json
            },
            body: JSON.stringify({ name: h2Title.textContent, poem: editedPoem.innerText, visibility: visibilityValue}),
          })
          .then((res) => {
                    console.log(res);
                    if (res.redirected) {
                        window.location.href = res.url;
                    }
                })
            .catch((err) => console.error(err));
    }

</script>

</html>